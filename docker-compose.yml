version: '3.8'

services:
  strapi:
    build: .
    container_name: strapi
    restart: unless-stopped
    env_file: .env
    volumes:
      # Persistent storage for uploaded files
      - strapi-uploads:/opt/app/public/uploads
      # If using SQLite for development/testing, ensure its data also persists
      # For production, we're using Postgres, so this is less critical here,
      # but good for consistency or local dev with containers.
      - strapi-db-file:/opt/app/.tmp/data.db
    expose:
      - '1337'
    networks:
      - traefik-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.strapi.rule=Host(`your_domain`)"
      - "traefik.http.routers.strapi.entrypoints=websecure"
      - "traefik.http.routers.strapi.tls.certresolver=letsencrypt"
      - "traefik.http.services.strapi.loadbalancer.server.port=1337"

  postgres:
    image: postgres:14-alpine
    container_name: postgres
    restart: unless-stopped
    env_file: .env
    volumes:
      # Persistent storage for PostgreSQL data
      - postgres-data:/var/lib/postgresql/data
    networks:
      - default # The default bridge network is sufficient for internal communication

  traefik:
    image: "traefik:v2.9"
    container_name: "traefik"
    restart: unless-stopped
    command:
      # Enable Traefik's API and dashboard (insecure for easy access, remove for production if not needed)
      - "--api.insecure=true"
      # Enable Docker as a provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false" # Only expose containers with traefik.enable=true
      # Entrypoints for HTTP and HTTPS
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Let's Encrypt configuration
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true" # Use TLS-ALPN-01 challenge
      - "--certificatesresolvers.letsencrypt.acme.email=your_email@example.com" # Replace with your email
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json" # Persistent storage for certificates
      # Redirect all HTTP traffic to HTTPS
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
    ports:
      - "80:80"   # The HTTP port
      - "443:443" # The HTTPS port
      - "8080:8080" # Traefik dashboard (optional, remove for production if not needed)
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro" # Mount the Docker socket for Traefik to discover containers
      - "traefik-public-certificates:/letsencrypt" # Volume for Let's Encrypt certificates
    networks:
      - traefik-proxy # Connect to the proxy network for external access

volumes:
  strapi-uploads: # Volume for Strapi uploads
  strapi-db-file: # Volume for SQLite data (if used in container, for persistence)
  postgres-data: # Volume for PostgreSQL data
  traefik-public-certificates: # Volume for Traefik's Let's Encrypt certificates

networks:
  traefik-proxy:
    # Use an external network for Traefik to connect to, allowing more flexibility
    # You'll need to create this network manually if it doesn't exist: docker network create traefik-proxy
    external: true
  default:
    driver: bridge # Default bridge network for internal communication between Strapi and Postgres
